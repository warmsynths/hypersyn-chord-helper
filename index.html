<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hypersyn Chord Helper</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="src/styles.css" />
  </head>
  <body class="flex flex-col items-center p-8 space-y-6 sm:p-4 sm:space-y-4">
    <!-- Synthwave video background -->
    <div
      id="video-bg"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -2;
        overflow: hidden;
      "
    >
      <video
        autoplay
        loop
        muted
        playsinline
        style="
          width: 100vw;
          height: 100vh;
          object-fit: cover;
          filter: blur(8px) brightness(0.7) saturate(1.1);
        "
      >
        <source src="src/assets/synthwave.mp4" type="video/mp4" />
      </video>
      <div
        style="
          position: absolute;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(40, 42, 54, 0.5);
          mix-blend-mode: soft-light;
        "
      ></div>
    </div>
    <h1
      class="synthwave-header text-5xl font-extrabold text-pink-400"
      style="font-family: 'Share Tech Mono', monospace !important"
    >
      Hypersyn Chord Helper
    </h1>

    <!-- Input Box with Example Progression -->
    <div class="content-box w-full max-w-lg">
      <textarea
        id="chordsInput"
        placeholder="Paste your chord progression here..."
        class="w-full p-2 border border-gray-300 rounded text-3xl"
      >
Am7 Dm9 G13 Cmaj7 Fmaj7 Bø7 E7alt Am9</textarea>
      <button
        onclick="convertChords()"
        class="mt-2 mb-2 px-4 py-2 bg-pink-600 text-white rounded w-full sm:w-auto sm:mb-0"
      >
        Convert
      </button>
      <div class="flex justify-center gap-4 mt-2">
        <a href="#infoBoxAnchor" class="underline" style="color: #8be9fd;">Help</a>
        <a href="#previewBoxAnchor" class="underline" style="color: #8be9fd;">Preview</a>
      </div>
    </div>
    <!-- Preview Box (moved directly below input) -->
    <div id="previewBoxAnchor" class="content-box w-full max-w-lg mt-6">
      <button
        onclick="toggleBox('previewBox')"
        class="mb-2 px-2 py-1 bg-gray-700 text-white rounded w-full sm:w-auto"
        data-box="previewBox"
      >
        Preview ▶
      </button>
      <span class="ml-2 text-gray-400 text-sm"
        >Play, stop, and adjust volume for your progression</span
      >
      <div id="previewBox" style="display: none;">
        <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-4">
          <button
            id="playBtn"
            onclick="handlePlay()"
            class="px-4 py-2 bg-green-600 text-white rounded transition-all border border-green-700 w-full sm:w-auto"
          >
            Play
          </button>
          <button
            id="stopBtn"
            onclick="handleStop()"
            class="px-4 py-2 text-white rounded transition-all border w-full sm:w-auto"
            style="background-color: #ff5555; border-color: #ff79c6"
          >
            Stop
          </button>
          <div class="flex flex-col sm:flex-row sm:items-center w-full sm:w-auto">
            <label class="text-yellow-300 mb-1 sm:mb-0 sm:ml-4">Volume:</label>
            <input
              id="volumeSlider"
              type="range"
              min="0"
              max="100"
              value="5"
              class="align-middle w-full sm:w-32"
              oninput="updateVolumeLabel()"
            />
            <span id="volumeLabel" class="ml-2 text-yellow-300">5%</span>
          </div>
        </div>
        <!-- Single Chord Preview -->
        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
          <select id="singleChordSelect" class="p-2 rounded border border-gray-300 w-full sm:w-auto dimmed" style="background:#282a36; color:#8be9fd;" disabled>
            <option value="">Select a chord...</option>
          </select>
          <button
            onclick="playSingleChord()"
            class="px-4 py-2 bg-purple-600 text-white rounded w-full sm:w-auto"
          >
            Play Chord
          </button>
        </div>
      </div>
    </div>
    <!-- Unique Chord Types Box -->
    <div class="content-box w-full max-w-lg">
      <button
        onclick="toggleBox('uniqueBox')"
        class="mb-2 px-2 py-1 bg-gray-700 text-white rounded w-full sm:w-auto"
        data-box="uniqueBox"
      >
        Unique Chord Types ▼
      </button>
      <span class="ml-2 text-gray-400 text-sm"
        >Groups by chord type and shows intervals</span
      >
      <div id="uniqueBox" class="hidden">
        <div id="uniqueChordTypes" class="text-lg"></div>
      </div>
    </div>
    <!-- Output Box -->
    <div class="content-box w-full max-w-lg">
      <button
        onclick="toggleBox('outputBox')"
        class="mb-2 px-2 py-1 bg-gray-700 text-white rounded w-full sm:w-auto"
        data-box="outputBox"
      >
        Converted Chords ▼
      </button>
      <span class="ml-2 text-gray-400 text-sm"
        >Shows all chords with hex and interval codes</span
      >
      <div id="outputBox" class="hidden">
        <div id="output" class="text-lg"></div>
      </div>
    </div>
    <!-- Info Box (moved to bottom) -->
    <div id="infoBoxAnchor" class="content-box w-full max-w-lg mt-6">
      <button
        onclick="toggleBox('infoBox')"
        class="mb-2 px-2 py-1 bg-gray-700 text-white rounded w-full sm:w-auto"
        data-box="infoBox"
      >
        Info ▶
      </button>
      <span class="ml-2 text-gray-400 text-sm">How to use this tool</span>
      <div id="infoBox" style="display: none">
        <div style="margin-bottom: 1rem">
          <ul
            style="
              margin-top: 0.75rem;
              margin-bottom: 0.75rem;
              line-height: 1.8;
            "
          >
            <li style="margin-bottom: 0.7em">
              <strong>Paste or type a chord progression</strong> into the input
              field above.<br />
              <span style="color: #bd93f9"
                >Use plain text with a single space between each chord.</span
              ><br />
              <span style="color: #ff79c6">Example:</span>
              <span style="color: #ff79c6">Am7 Dm9 G13 Cmaj7</span>
            </li>
            <li style="margin-bottom: 0.7em">
              <strong>Source progressions</strong> from sites like:<br />
              <a
                href="https://www.onemotion.com/chord-player/"
                target="_blank"
                style="color: #8be9fd; text-decoration: underline"
                >onemotion chord player</a
              >,<br />
              <a
                href="https://chordseqai.com/"
                target="_blank"
                style="color: #8be9fd; text-decoration: underline"
                >ChordSeqAI</a
              >,<br />
              or generate them with
              <a
                href="https://chatgpt.com/"
                target="_blank"
                style="color: #8be9fd; text-decoration: underline"
                >ChatGPT</a
              >.
            </li>
            <li style="margin-bottom: 0.7em">
              <strong>Click <span style="color: #ff79c6">Convert</span></strong>
              to see each chord’s hex code and interval code.<br />
              <span style="color: #f1fa8c"
                >These can be used directly in the Hypersyn instrument on the M8
                Tracker.</span
              >
            </li>
            <li style="margin-bottom: 0.7em">
              <strong>Click <span style="color: #50fa7b">Play</span></strong> to
              audition the progression as a synth pad,<br />
              or <strong><span style="color: #ff5555">Stop</span></strong> to
              halt playback.
            </li>
            <li style="margin-bottom: 0.7em">
              <strong
                >Explore the
                <span style="color: #8be9fd">Unique Chord Types</span>
                box</strong
              >
              to see interval structures grouped by type.
            </li>
          </ul>
        </div>
        <p>
          <span class="root-baked-label">Root-baked hex codes</span> include the
          chord’s root — ready to drop straight into Hypersyn.
        </p>
        <p>
          <span class="interval-label">Interval-only codes</span> are just the
          chord shape — you choose the root yourself in the phrase view.
        </p>
      </div>
    </div>

    <script type="text/javascript" src="src/core.js"></script>
    <script>
      // Track play state
      let isPlaying = false;

      function setPlayVisualState(playing) {
        const playBtn = document.getElementById("playBtn");
        const stopBtn = document.getElementById("stopBtn");
        if (playing) {
          playBtn.classList.add(
            "ring-4",
            "ring-green-300",
            "scale-95",
            "shadow-lg"
          );
          stopBtn.classList.add(
            "ring-2",
            "ring-red-400",
            "scale-105",
            "shadow-md"
          );
        } else {
          playBtn.classList.remove(
            "ring-4",
            "ring-green-300",
            "scale-95",
            "shadow-lg"
          );
          stopBtn.classList.remove(
            "ring-2",
            "ring-red-400",
            "scale-105",
            "shadow-md"
          );
        }
      }

      function handlePlay() {
        if (!isPlaying) {
          isPlaying = true;
          setPlayVisualState(true);
          window.playChordProgression();
          // Estimate total duration and reset state after
          const input = document.getElementById("chordsInput").value;
          const chordCount = input
            .split(/\s|,/)
            .filter((s) => s.length > 0).length;
          const chordDuration = 2.5;
          setTimeout(() => {
            isPlaying = false;
            setPlayVisualState(false);
          }, chordCount * chordDuration * 1000 + 100);
        }
      }

      function handleStop() {
        if (isPlaying) {
          isPlaying = false;
          setPlayVisualState(false);
          window.stopChordProgression();
        } else {
          window.stopChordProgression();
        }
      }
      // Only keep updateVolumeLabel and UI logic
      function updateVolumeLabel() {
        const slider = document.getElementById("volumeSlider");
        document.getElementById("volumeLabel").textContent = slider.value + "%";
      }

      function toggleBox(boxId) {
        const el = document.getElementById(boxId);
        if (!el) return;
        const isOpen = el.style.display === "none" ? false : true;
        el.style.display = isOpen ? "none" : "block";
        // Find the button that toggles this box
        const btns = document.querySelectorAll(
          `button[onclick*="toggleBox('${boxId}'"]`
        );
        btns.forEach((btn) => {
          if (isOpen) {
            btn.innerHTML = btn.innerHTML.replace("▼", "▶");
          } else {
            btn.innerHTML = btn.innerHTML.replace("▶", "▼");
          }
        });
      }

      function updateSingleChordDropdown(chordNames) {
        const select = document.getElementById('singleChordSelect');
        if (!select) return;
        select.innerHTML = '<option value="">Select a chord...</option>';
        chordNames.forEach((chord) => {
          select.innerHTML += `<option value="${chord}">${chord}</option>`;
        });
        select.disabled = false;
        select.classList.remove('dimmed');
      }

      // Patch convertChords to update dropdown
      const originalConvertChords = window.convertChords;
      window.convertChords = function() {
        const input = document.getElementById("chordsInput").value;
        const chordNames = input.split(/\s|,/).filter((s) => s.length > 0);
        updateSingleChordDropdown(chordNames);
        if (typeof originalConvertChords === 'function') originalConvertChords();
      };

      function convertChords() {
        // Show unique and converted chord boxes
        document.getElementById("uniqueBox").style.display = "block";
        document.getElementById("outputBox").style.display = "block";
        // Get dropdown buttons once
        const uniqueBtn = document.querySelector(
          'button[data-box="uniqueBox"]'
        );
        const outputBtn = document.querySelector(
          'button[data-box="outputBox"]'
        );
        // Set dropdown icons to ▼ when content is shown
        if (uniqueBtn)
          uniqueBtn.innerHTML = uniqueBtn.innerHTML.replace("▶", "▼");
        if (outputBtn)
          outputBtn.innerHTML = outputBtn.innerHTML.replace("▶", "▼");
        if (typeof window.convertChords !== "function") {
          document.getElementById("output").innerHTML =
            '<span style="color:red">Chord logic not loaded.</span>';
          return;
        }

        // Use the logic from core.js
        const input = document.getElementById("chordsInput").value;
        const chordNames = input.split(/[\s,]+/).filter((s) => s.length > 0);
        const parsed = chordNames
          .map(window.parseChordName)
          .filter((c) => c !== null);

        // Display all input chords as entered
        let outputHTML = "";
        parsed.forEach((chord) => {
          outputHTML += `
          <div class="mb-4">
            <span class="chord-name">${chord.chordName} (${
            chord.type
          })</span><br>
            <span class="root-baked-label">Root-baked:</span> 
            <span class="root-baked-value">${chord.rootBaked.join(
              " "
            )}</span><br>
            <span class="interval-label">Interval:</span> 
            <span class="interval-value">${chord.intervalOnlyHex.join(
              " "
            )}</span>
          </div>
        `;
        });
        document.getElementById("output").innerHTML = outputHTML;
        // Dim output dropdown button if no chords
        if (!outputHTML.trim()) {
          outputBtn.classList.add("dimmed");
        } else {
          outputBtn.classList.remove("dimmed");
        }

        // Use core.js grouping logic for unique chord types
        const uniqueGroups = window.getUniqueChordTypes(parsed);
        let uniqueHTML =
          '<span class="interval-label">Unique Chord Types:</span><ul style="margin-top:0.5rem;">';
        uniqueGroups.forEach((group, idx) => {
          uniqueHTML += `<li>
            <span class="chord-name">Chord ${idx
              .toString()
              .padStart(2, "0")}</span><br>
            <span class="root-baked-label">Chords:</span> <span class="root-baked-value">${group.chords.join(
              ", "
            )}</span><br>
            <span class="interval-label">Interval:</span> <span class="interval-value">${group.intervalOnlyHex.join(
              " "
            )}</span>
          </li>`;
        });
        uniqueHTML += "</ul>";
        document.getElementById("uniqueChordTypes").innerHTML = uniqueHTML;
        // Dim unique dropdown button if no unique chords
        if (!uniqueHTML || uniqueHTML.indexOf("<li>") === -1) {
          uniqueBtn.classList.add("dimmed");
        } else {
          uniqueBtn.classList.remove("dimmed");
        }
      }

      function playSingleChord() {
        const select = document.getElementById('singleChordSelect');
        const chordName = select.value;
        if (!chordName || chordName === 'Select a chord...') return;
        const chordObj = window.parseChordName(chordName);
        if (chordObj && typeof window.playSingleChordGlobal === 'function') {
          window.playSingleChordGlobal(chordObj);
        } else {
          alert('Chord playback not available.');
        }
      }
    </script>
  </body>
  <!-- Video credit as page content -->
  <div
    id="video-credit"
    style="
      margin: 2.5rem auto 0 auto;
      font-size: 0.95rem;
      color: #8be9fd;
      background: rgba(40, 42, 54, 0.7);
      padding: 6px 14px;
      border-radius: 8px;
      font-family: 'Share Tech Mono', monospace;
      box-shadow: 0 2px 8px #000;
      text-align: center;
      display: inline-flex;
      align-items: center;
    "
  >
    <span style="display: inline">
      Video by
      <a
        href="https://www.reddit.com/user/visualdon/"
        target="_blank"
        style="color: #ff79c6; text-decoration: underline"
        >visualdon</a
      >
      on Reddit
    </span>
    <button
      id="toggleVideoBtn"
      onclick="toggleVideoBg()"
      style="
        background: #282a36;
        color: #f8f8f2;
        border: none;
        border-radius: 5px;
        padding: 2px 10px;
        font-size: 0.95em;
        cursor: pointer;
        margin-left: 0.7em;
        display: inline;
      "
    >
      Hide Video
    </button>
  </div>
  <style>
    .dimmed {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</html>
